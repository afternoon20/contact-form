# お問い合わせフォーム

## 開発環境

- macOS 10.13.6(ホスト OS)
- VirtualBox 6.1.18
- CentOS 7.9.2009(ゲスト OS)
- Apache 2.4.6
- MySQL 8.0.23
- PHP 7.4.15

## 実装に費やした時間

- フロントエンド 2 時間
  - HTML5
  - CSS3(Sass)
  - Bootstrap4
  - Javascript
- バックエンド 4 時間
  - PHP
- 環境構築 14 時間
  - CentOS
  - MySQL
  - Apache
  - Gmail

## 実装中に問題となったところ・工夫したところ

- メール送信に Gmail の SMTP サーバーを使用し、config.php に必要な情報を入力するだけで送信できるようにした。
- 電話番号はハイフンありでも入力できるようにし、データベース格納時にはハイフンなしの最大桁数(12 桁)で登録できるように実装。
- データベースやメールサーバーの設定を config.php で一元管理することで、異なる環境や端末での検証も効率的に行うことができるようにした。
- 二重送信を防ぐため、送信完了ページでブラウザバックを行うとフォームページに遷移するように実装。
- SQL インジェクション対策として、SQL 文の生成時にはプレースホルダを用いて実装。
- Postfix を使用してメール送信ができなかったため、PHP のライブラリ「PHPMailer」を使うことでメールを送信することができた。
- フォームの値を保持しているかどうかのフラグを用意し、保持していない場合はトップ画面に強制遷移するようにした。
- 確認ページ遷移時、バックエンド側でバリデーションチェックを実施し、エラーがある場合は値を保持したままフォームページに戻り、エラーメッセージを表示するように実装。
- 仮想化環境(CentOS)を構築するのは初めてだったので、環境構築に多くの工数を割いてしまった。
- バリデーションチェック、サニタイズの実装、SQL インジェクション対策など、セキュリティを意識した実装をすることができた。

## 改善点

- バックエンドでのエラーがあった場合に、エラーメッセージを表示するだけでなくログファイルを出力しエラーの原因を把握しやすくしたい。
-

## 動作確認

- テーブルはフォルダ内の sql ファイルをインポートしたものを使用。
- Google の SMTP 経由でメールを送信し、メールが正しく送信されている。
- 送信完了後、入力値がデータベースに登録されている。
- 管理者とユーザーにそれぞれメールが正常に送信されている。

### 検証ブラウザ

- Firefox 78.7.0esr
- Google Chrome 88.0.4324.150

### フォームページ

- すべて正常値の場合のみ確認ページに遷移する。

#### 入力チェック(未入力、閾値、文字数オーバー、正しいメールアドレス、電話番号の表記など)

- 件名(セレクトボックス:ご意見 | ご感想 | その他)

  - 正しい選択肢のみ表示
  - 選択肢以外を選ぶとエラーメッセージ表示
  - 未選択の場合エラーメッセージ表示
  - プルダウン値から選択すると正常に遷移

- 名前(50 文字以内 必須)

  - 未入力の場合はエラーメッセージ表示。
  - 50 文字以上は入力できない。(maxlength="50")
  - 半角英数字 50 文字以内の入力で正常に遷移。
  - 半角英数字 50 文字以上入力した場合はエラーメッセージ表示。
  - 閾値の入力(48~50 文字:OK, 51~52 文字:NG)

- メールアドレス(必須 255 文字以内)

  - RFC822 に沿った形式(ユーザー名@ドメイン)かつ半角英数字 255 文字で正常に遷移。
  - 全角入力でエラーメッセージ表示。
  - RFC822 に沿わない形式(ユーザー名@ドメイン)の場合はエラーメッセージ表示。
  - 未入力の場合はエラーメッセージ表示。

- 電話番号(必須 半角数字 12 桁以内 先頭は 0)

  - 先頭 0 以外でエラーメッセージ表示
  - 先頭 0 の半角数字 12 桁で正常に遷移
  - 半角/全角文字でエラーメッセージ表示。
  - 閾値の入力(11~12 桁:OK, 13~14 桁:NG)
  - ハイフンあり 半角数字 12 桁で正常に遷移
  - ハイフンなし半角数字 12 桁で正常に遷移

- お問い合わせ内容

  - 未入力の場合はエラーメッセージ表示。
  - 255 文字以上は入力できない。(maxlength="255")
  - 半角英数字 255 文字以内の入力で正常に遷移。
  - 半角英数字 255 文字以上入力した場合はエラーメッセージ表示。
  - 閾値の入力(254~255 文字:OK, 256~257 文字:NG)

#### 確認ページ

- 入力値が正常に表示されている。
- 修正ボタンを押すと、入力値を保持したままフォームページ戻る。
- 送信ボタンを押すと、送信完了ページに遷移。
- お問い合わせ内容の入力に改行がある場合、改行されて表示されている。

#### 送信完了ページ

- 送信した内容が表示されている。
- 送信後に戻るボタン/更新ボタンを押下すると、トップページに遷移する。

## 参考資料

- [LAMP 環境構築マニュアル ① 　概要編](https://pointsandlines.jp/server-infra/lamp-overview)
- [Windows10 に VirtualBox で centos7 環境を構築する](https://qiita.com/apricotcomic/items/035dc1c0c7ad08054495)
- [CentOS7 IP アドレスを固定する](https://qiita.com/miriwo/items/5791f552055fda573cf3)
- [CentOS7 に最新版の Git をインストールする方法](https://qiita.com/tomy0610/items/66e292f80aa1adc1161d)
- [【2021 年版】Postfix から Gmail 経由でメールを送信する方法](https://codeforfun.jp/how-to-send-email-with-postfix-and-gmail/)
- [お問い合わせフォームを作る](https://gray-code.com/php/make-the-form-introduction/)
- [PHPMailer/PHPMailer: The classic email sending](https://github.com/PHPMailer/PHPMailer)
- [PHPMailer でメールを STMP 送信する](https://qiita.com/e__ri/items/857b12e73080019e00b5)
- [SQL インジェクションとその対策(PHP + PDO)](https://qiita.com/kurodenwa/items/8807e79515c0e2b4dad9)
- [CentOS の Postfix で Gmail 経由でメールを出す+PHP で送信できない場合。](https://www.ituki-yu2.net/entry/20140805/1407247229)
